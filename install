#!/bin/bash
set -euo pipefail
IFS=$'\n\t'

if [[ $OSTYPE == 'darwin'* ]]; then
    ./osx.sh
elif lsb_release --description | grep "elementary OS" --silent; then
    ./elementary.sh
fi

function add-line-to-file() {
    FILE="$1"
    LINE="$2"

    grep -qxF "$LINE" "$FILE" || echo "$LINE" >>"$FILE"
}

stow git
stow asdf

if [ ! -d "$HOME/.asdf" ]; then
    git clone "https://github.com/asdf-vm/asdf.git" "$HOME/.asdf" --branch v0.11.3
fi

if [[ "$SHELL" = "/bin/bash" ]]; then
    add-line-to-file "$HOME/.bashrc" '. "$HOME/.asdf/asdf.sh"'
    add-line-to-file "$HOME/.bashrc" '. "$HOME/.asdf/completions/asdf.bash"'
    . "$HOME/.asdf/asdf.sh"
    . "$HOME/.asdf/completions/asdf.bash"
fi

asdf plugin list | grep --quiet nodejs || asdf plugin add nodejs
NODEJS_VERSION="19.8.1"
asdf list nodejs | grep --quiet "$NODEJS_VERSION" || asdf install nodejs "$NODEJS_VERSION"

if [[ "$SHELL" = "/bin/bash" ]]; then
    add-line-to-file "$HOME/.bashrc" 'export PATH="$HOME/.dotfiles/scripts:$PATH"'
fi
PATH="$HOME/.dotfiles/scripts:$PATH"
